/*! rmsWebconfig 2014-03-14 author:hellangel*/
!function(){window.HAT||(window.HAT={})}(),HAT.User={_oUserlistTable:"",_oUserNameList:[],_dialog:"",_oChlList:null,_sCurrentUsername:"",_oBindList:null,searchFlag:!1,initPage:function(){PosaUI.Table&&(HAT.User._oUserlistTable=new PosaUI.Table("userlist_table",{height:300,footer:!0,align:"center",thead:[{name:'<input type="checkbox" id="parentCheckbox" onclick="HAT.User.optAllUserList()">',width:10,align:"center"},{name:"序号",width:10,align:"center"},{name:"用户名",width:30,align:"center"},{name:"通道数",width:15,align:"center"},{name:"操作",width:35,align:"center"}]}),HAT.User.getUserlistInfo())},getUserlistInfo:function(a){var b={name:""};a&&(b.name=a),HAT.ajax.post(HAT.target.userlist,"get",b,function(a){if(0==a.status){if(HAT.User._oUserlistTable.clear(),!a.data)return void HAT.msg.infoAlert("没有搜索到相关信息!");HAT.User.initUserlistTable(a.data),HAT.User._oUserNameList=[];for(var b=a.data.users,c=0;c<b.length;c++)HAT.User._oUserNameList[c]={label:b[c].name,category:""};$("#searchName").catcomplete({delay:0,source:HAT.User._oUserNameList}).val("")}})},initUserlistTable:function(a){var b=a.users,c=HAT.User._oUserlistTable;if(c&&b)for(var d=0;d<b.length;d++)c.append(["admin"==b[d].name?"":'<input type="checkbox" onclick="HAT.User.modifyStatus();" name="userListCheckbox" value="'+b[d].name+'" />',d+1,b[d].name,b[d].channel_count,c.btnPlay("查看","HAT.User.showCheckUserlist('"+b[d].name+"')")+c.btnEdit("修改","HAT.User.showModifyChannellist('"+b[d].name+"')")+c.btnDel(!1,"HAT.User.batchRemoveUser('"+b[d].name+"')")])},modifyStatus:function(){var a=HAT.User.getCheckedUser();a.length<=0?$("#parentCheckbox").prop("checked",!1):a.length==HAT.User._oUserNameList.length-1&&$("#parentCheckbox").prop("checked",!0)},searchUserByName:function(){this.getUserlistInfo($("#searchName").val()||"")},batchRemoveUser:function(a){var b={},c=[];return"admin"==a?(HAT.msg.infoAlert("不能删除 admin!"),!1):confirm("确定要删除用户吗?")?(a?(c[0]={name:a},b.users=c):b.users=this.getCheckedUser(),void HAT.ajax.post(HAT.target.userldel,"set",b,function(a){0==a.status&&(HAT.msg.infoAlert("用户删除成功!"),HAT.User.initPage())})):!1},optAllUserList:function(){$("#parentCheckbox").is(":checked")?$("input[name='userListCheckbox']").prop("checked",!0):$("input[name='userListCheckbox']").prop("checked",!1)},showAddUser:function(){$("#messages > div").removeClass("show").addClass("hide"),$("#adduser").addClass("show"),$("#inputAdduser_name").val("").focus(),$("#inputAdduser_pwd").val(""),$("#inputAdduser_pwdr").val("")},saveAddUser:function(){var a=$("#inputAdduser_name").val(),b=$("#inputAdduser_pwd").val(),c=$("#inputAdduser_pwdr").val(),d={users:{}};if(!a||!b||!c)return HAT.msg.infoError("请输入正确的参数!"),!1;if(b!=c)return HAT.msg.infoError("两次输入的密码不匹配!"),$("#inputAdduser_pwd").val(""),$("#inputAdduser_pwdr").val(""),!1;var e=hex_md5(a+"_"+b),f=hex_md5(b+"_"+a);d.users.name=a,d.users.pwd_ordered=e,d.users.pwd_reverse=f,HAT.ajax.post(HAT.target.useradd,"set",d,function(a){0==a.status&&HAT.msg.infoAlert("用户添加成功!")})},resetUserPwd:function(){var a={};return a.users=this.getCheckedUser(),a.users.length<=0?void HAT.msg.infoWarning("请选择您要重置的用户!"):void HAT.ajax.post(HAT.target.resetpwd,"set",a,function(a){0==a.status&&(HAT.msg.infoAlert("用户密码重置成功,密码默认为'123456'!"),HAT.User.initPage())})},getCheckedUser:function(){var a=[];return $.each($("input[name='userListCheckbox']"),function(b,c){$(c).prop("checked")&&(a[b]={name:c.value})}),a},saveModifyPwd:function(){var a=$("#modifyPwd_name").text(),b=$("#inputModifypwd_pwdo").val(),c=$("#inputModifypwd_pwdn").val(),d=$("#inputModifypwd_pwdnr").val(),e={users:{}};if(""==a||""==b||""==c||""==d)return HAT.msg.infoError("请输入合法数据!"),!1;if(c!=d)return HAT.msg.infoError("两次输入密码不匹配!"),$("#inputModifypwd_pwdo").val(""),$("#inputModifypwd_pwdn").val(""),$("#inputModifypwd_pwdnr").val(""),!1;var f=hex_md5(a+"_"+c),g=hex_md5(c+"_"+a);e.users.name=a,e.users.old_pwd=hex_md5(a+"_"+b),e.users.new_pwd_ordered=f,e.users.new_pwd_reverse=g,HAT.ajax.post(HAT.target.userlmodify,"set",e,function(a){0==a.status&&HAT.msg.infoAlert("用户密码修改成功!")})},showModifyChannellist:function(a){$("#channelSearchName").val(""),HAT.User._sCurrentUsername=a;var b=$("#channelList-list");$("#messages > div").removeClass("show").addClass("hide"),$("#bindChanel").addClass("show"),$("#bindChanel_name").text(a);var c=HAT.Tree._oTreeSetting;c.check.enable=!0,c.check.chkStyle="checkbox",c.check.chkboxType={Y:"ps",N:"ps"},c.check.autoCheckTrigger=!0,c.callback.beforeExpand=HAT.User.beforeExpandCallback,c.callback.onClick=HAT.User.onClickCallbackForListModify,c.callback.beforeCheck=HAT.User.onCheckCallback,HAT.Tree._oTreeRoot.showAll=!0,HAT.User.searchFlag=!1;var d=HAT.Tree.initTree(b,c,HAT.Tree._oTreeRoot);d&&HAT.User.getChannelList(a,d.getNodeByParam("id",HAT.treeRootName),"channelList-list",HAT.searchMode.general,HAT.User.showChannelListTree)},showChannelListTree:function(a,b,c){var d=a.channel_list,e=$.fn.zTree.getZTreeObj("channelList-list"),f=[],g={},h=!0;if(d&&e){for(var i=0;i<d.length;i++)"undefined"!=typeof d[i].status&&(h=d[i].status),f[i]={pId:d[i].pid,id:d[i].name,name:d[i].title,checked:d[i].binded,isHidden:!1,status:h,icon:HAT.User.getChannelIcon(d[i].nodetype,h)},HAT.User.searchFlag?($("#btnUncheckAllNodes").addClass("hide"),$("#btnCheckAllNodes").addClass("hide")):(f[i].isParent=d[i].nodetype,$("#btnUncheckAllNodes").removeClass("hide"),$("#btnCheckAllNodes").removeClass("hide"));"string"==typeof b?g=e.getNodeByParam("id",HAT.treeRootName):"object"==typeof b&&(g=b),HAT.Tree.updateTreeNodes(g,f,c)}},getChannelIcon:function(a,b){var c="";return c=a?b?HAT.Tree._oIconPath.deviceOnline:HAT.Tree._oIconPath.deviceOffline:c=b?HAT.Tree._oIconPath.channelOnline:HAT.Tree._oIconPath.channelOffline},showModifyPwd:function(a){$("#messages > div").removeClass("show").addClass("hide"),$("#updateuser").addClass("show"),$("#inputModifypwd_pwdo").val("").focus(),$("#inputModifypwd_pwdn").val(""),$("#inputModifypwd_pwdnr").val(""),$("#modifyPwd_name").text(a)},showCheckUserlist:function(a){HAT.User._sCurrentUsername=a;var b=$("#deviceList-list");$("#messages > div").removeClass("show").addClass("hide"),$("#usercheck").addClass("show"),$("#userlist_name").text(a);var c=HAT.Tree._oTreeSetting;c.check.enable=!1,c.callback.beforeExpand=HAT.User.beforeExpandCallback,c.callback.onClick=HAT.User.onClickCallbackForListDisplay,c.callback.onDblClick=HAT.User.onRightClickCallbackForListDisplay,HAT.Tree._oTreeRoot.showAll=!1;var d=HAT.Tree.initTree(b,c,HAT.Tree._oTreeRoot);d&&HAT.User.getChannelList(a,d.getNodeByParam("id",HAT.treeRootName),"deviceList-list",HAT.searchMode.general,HAT.User.showUserBindTree)},getChannelList:function(a,b,c,d,e){var f={name:a,channelname:d?b:b.id,searchflag:d};HAT.ajax.post(HAT.target.channellist,"get",f,function(a){if(0==a.status){if(!a.data||!a.data.channel_list){if(d){HAT.msg.infoAlert("没有找到与之相关的设备!");var f=$.fn.zTree.getZTreeObj("channelList-list");f.removeChildNodes(f.getNodeByParam("id",HAT.treeRootName))}else HAT.msg.infoAlert("该设备还没有添加通道!");return}e&&e(a.data,b,c)}})},showUserBindTree:function(a,b,c){var d=a.channel_list,e=$.fn.zTree.getZTreeObj("deviceList-list"),f=[],g=!0;if(d&&e){for(var h=0;h<d.length;h++)"undefined"!=typeof d[h].status&&(g=d[h].status),f[h]={pId:d[h].pid,id:d[h].name,name:d[h].title,isParent:d[h].nodetype,isHidden:!d[h].binded,status:g,icon:HAT.User.getChannelIcon(d[h].nodetype,g)};HAT.Tree.updateTreeNodes(b,f,c)}},saveBindChannel:function(a){var b={title:a.name,name:a.id,pid:a.pId,binded:a.checked,nodetype:a.isParent},c={name:$("#bindChanel_name").text(),channel_list:[b]};HAT.ajax.post(HAT.target.channellist,"set",c,function(a){0==a.status&&HAT.msg.infoAlert("配置已保存!")})},searchChannelByName:function(){var a=$("#bindChanel_name").text(),b=$("#channelSearchName").val();return b?(HAT.User.searchFlag=!0,void HAT.User.getChannelList(a,b,"channelList-list",HAT.searchMode.fuzzy,HAT.User.showChannelListTree)):void HAT.msg.infoWarning("请输入需要查找的关键字!")},checkAllNodes:function(a){var b=a?"'绑定所有设备'":"'取消所有设备的绑定'";if(!confirm("您确定要"+b+"? 该操作是不可逆的,建议您谨慎操作!"))return!1;var c=$.fn.zTree.getZTreeObj("channelList-list");c&&c.checkAllNodes(a);var d=c.getNodeByParam("id",HAT.treeRootName),e={title:d.name,name:d.id,pid:d.pId,binded:a,nodetype:d.isParent},f={name:$("#bindChanel_name").text(),channel_list:[e]};HAT.ajax.post(HAT.target.channellist,"set",f,function(a){0==a.status&&HAT.msg.infoAlert("配置已保存!")})},refreshChannelList:function(){$("#channelSearchName").val("");var a=$.fn.zTree.getZTreeObj("channelList-list");HAT.User.searchFlag=!1,HAT.User.getChannelList($("#bindChanel_name").text(),a.getNodeByParam("id",HAT.treeRootName),"channelList-list",HAT.searchMode.general,HAT.User.showChannelListTree)},onClickCallbackForListDisplay:function(){return!0},onRightClickCallbackForListDisplay:function(a,b,c){return c.status?c.isParent?void HAT.msg.infoAlert("该节点不是通道!"):(HAT.Player.addChannel(HAT.Param.param.rms_id,c.id,c.pId),void HAT.Player.play(c.id,"正在播放通道 "+c.name+" 的实时视频!")):void HAT.msg.infoAlert("该通道不在线!")},beforeExpandCallback:function(a,b){var c={};return c=HAT.Tree._oTreeRoot.showAll?HAT.User.showChannelListTree:HAT.User.showUserBindTree,HAT.User.searchFlag?void 0:b.isAjaxing?(alert("正在下载数据中，请稍后展开节点。。。"),!1):(HAT.User.getChannelList(HAT.User._sCurrentUsername,b,a,HAT.searchMode.general,c),!0)},onClickCallbackForListModify:function(a,b,c){var d=$.fn.zTree.getZTreeObj(b);d&&c&&(c.checked=!c.checked,d.updateNode(c,!0),HAT.User.saveBindChannel(c))},onCheckCallback:function(a,b){return HAT.User.onClickCallbackForListModify("",a,b),!1}};